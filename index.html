<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BHC Chat</title>
<style>
body { margin:0; font-family:'Segoe UI',sans-serif; background:#0a0f1a; color:#fff; height:100vh; display:flex; flex-direction:column; }
header { background:#0f1524; padding:1rem; display:flex; justify-content:space-between; align-items:center; font-size:1.5rem; font-weight:bold; }
#currentChat { font-size:0.9rem; color:#7a7a7a; margin-left:1rem; }
#returnGlobalBtn { display:none; background:#0b78e3; color:#fff; border:none; border-radius:5px; padding:0.3rem 0.6rem; cursor:pointer; }
#chatContainer { display:flex; flex:1; overflow:hidden; }
#userList { width:220px; border-right:1px solid #1c2335; overflow-y:auto; padding:0.5rem; }
#userList h3 { margin-top:0; margin-bottom:0.5rem; display:flex; justify-content:space-between; align-items:center; }
#userList ul { list-style:none; padding:0; margin:0; }
#userList li { padding:0.5rem; cursor:pointer; border-radius:5px; display:flex; flex-direction:column; }
#userList li:hover { background:#1c2335; }
#userList li.active { background:#0b78e3; }
.user-name { display:flex; align-items:center; gap:0.5rem; }
.user-notif { font-size:0.75rem; color:#ff3333; }
.chatMain { display:flex; flex-direction:column; flex:1; }
#typingIndicator { font-size:0.85rem; color:#7a7a7a; padding-left:1rem; margin-bottom:0.2rem; height:18px; }
#messages { flex:1; padding:1rem; overflow-y:auto; display:flex; flex-direction:column; gap:0.3rem; background:#101426; scrollbar-width:thin; scrollbar-color:#0b78e3 #101426; }
#messages::-webkit-scrollbar { width:8px; }
#messages::-webkit-scrollbar-track { background:#101426; }
#messages::-webkit-scrollbar-thumb { background:#0b78e3; border-radius:4px; }
.message { padding:0.6rem 1rem; border-radius:15px; max-width:65%; word-break:break-word; display:flex; align-items:center; }
.message.self { background:#0b78e3; align-self:flex-end; color:#fff; flex-direction:row-reverse; }
.message.other { background:#1c2335; align-self:flex-start; color:#fff; }
.timestamp { font-size:0.65rem; color:#7a7a7a; margin-left:0.5rem; margin-right:0.5rem; }
#input { display:flex; padding:0.5rem; background:#141a2c; border-top:1px solid #1c2335; }
#input input { flex:1; padding:0.6rem 1rem; border-radius:20px 0 0 20px; border:none; background:#101426; color:#fff; }
#input button { padding:0.6rem 1.2rem; border:none; border-radius:0 20px 20px 0; background:#0b78e3; color:#fff; cursor:pointer; font-weight:bold; }
#authModal, #groupModal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); display:flex; align-items:center; justify-content:center; z-index:10; }
#authBox, #groupBox { background:#101426; padding:2rem; border-radius:15px; width:320px; display:flex; flex-direction:column; box-shadow:0 5px 20px rgba(0,0,0,0.5); }
#authBox input, #groupBox input { margin-bottom:1rem; padding:0.6rem; border-radius:8px; border:none; background:#141a2c; color:#fff; }
#authBox button, #groupBox button { padding:0.6rem; border:none; border-radius:8px; background:#0b78e3; color:#fff; font-weight:bold; cursor:pointer; }
.profile-circle { display:inline-flex; justify-content:center; align-items:center; width:30px; height:30px; border-radius:50%; color:#fff; font-weight:bold; font-size:0.8rem; flex-shrink:0; }
#groupButton { font-size:0.8rem; padding:0.2rem 0.4rem; }
.group-user { display:flex; justify-content:space-between; align-items:center; padding:0.3rem 0; }
.group-selected { background:#0b78e3; }
</style>
</head>
<body>

<header>
  <span>BHC Chat</span>
  <span id="currentChat">Global Chat</span>
  <button id="returnGlobalBtn">Global Chat</button>
</header>

<div id="chatContainer">
  <div id="userList">
    <h3>Users <button id="groupButton">+ Group</button></h3>
    <ul id="users"></ul>
  </div>
  <div class="chatMain">
    <div id="typingIndicator"></div>
    <div id="messages"></div>
    <div id="input">
      <input type="text" id="messageInput" placeholder="Type your message...">
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<div id="authModal">
  <div id="authBox">
    <h2>Enter Code</h2>
    <input type="text" id="codeInput" placeholder="Enter your code">
    <button id="loginBtn">Enter Chat</button>
  </div>
</div>

<div id="groupModal" style="display:none;">
  <div id="groupBox">
    <h2>Create Group</h2>
    <input type="text" id="groupNameInput" placeholder="Group Name">
    <input type="text" id="searchUserInput" placeholder="Search Users">
    <div id="searchResults"></div>
    <button id="createGroupSubmit">Create Group</button>
    <button id="cancelGroup">Cancel</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
document.addEventListener('DOMContentLoaded',()=>{
const supabaseUrl='https://azpgwbxillscpwrraprl.supabase.co';
const supabaseKey='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6cGd3YnhpbGxzY3B3cnJhcHJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg1MjQsImV4cCI6MjA3MjYzNDUyNH0.h7ZDxtH4pB3K5IzRB9goLJ1ldrY6EGf7CWT-ELGQ0i0';
const client=supabase.createClient(supabaseUrl,supabaseKey);

let currentUser=null;
let privateChatUser=null;
let currentGroup=null;
const messagesEl=document.getElementById('messages');
const messageInput=document.getElementById('messageInput');
const sendBtn=document.getElementById('sendBtn');
const codeInput=document.getElementById('codeInput');
const loginBtn=document.getElementById('loginBtn');
const authModal=document.getElementById('authModal');
const typingIndicator=document.getElementById('typingIndicator');
const usersEl=document.getElementById('users');
const currentChatEl=document.getElementById('currentChat');
const returnGlobalBtn=document.getElementById('returnGlobalBtn');
const groupModal=document.getElementById('groupModal');
const groupButton=document.getElementById('groupButton');
const groupNameInput=document.getElementById('groupNameInput');
const searchUserInput=document.getElementById('searchUserInput');
const searchResults=document.getElementById('searchResults');
const createGroupSubmit=document.getElementById('createGroupSubmit');
const cancelGroup=document.getElementById('cancelGroup');

let typingUsers=new Set();
let typingTimeout;
let unreadCounts={};

function getInitials(name){return name.split(' ').map(n=>n[0].toUpperCase()).join('').slice(0,2);}
function stringToColor(str){let hash=0;for(let i=0;i<str.length;i++){hash=str.charCodeAt(i)+((hash<<5)-hash);}return `hsl(${hash%360},70%,50%)`;}
function createProfileCircle(username){const span=document.createElement('span');span.className='profile-circle';span.style.background=stringToColor(username);span.textContent=getInitials(username);return span;}
function appendMessage(message,type){const div=document.createElement('div');div.className='message '+type;div.appendChild(createProfileCircle(message.username));const content=document.createElement('span');content.innerHTML=`<strong>${message.username}</strong>: ${message.message} <span class="timestamp">${new Date(message.created_at).toLocaleTimeString()}</span>`;div.appendChild(content);messagesEl.appendChild(div);messagesEl.scrollTop=messagesEl.scrollHeight;}
function updateTypingIndicator(){if(typingUsers.size===0){typingIndicator.textContent='';return;}const names=Array.from(typingUsers);typingIndicator.textContent=names.length===1?`${names[0]} is typing...`:`${names.join(' and ')} are typing...`;}
function updateTitle(){let count=0;for(let key in unreadCounts){count+=unreadCounts[key];}document.title=count>0?`(${count}) BHC Chat`:'BHC Chat';}

async function loginWithCode(code){
 const {data,error}=await client.from('chat_codes').select('username').eq('code',code).single();
 if(error||!data){alert('Invalid code');return false;}
 currentUser={username:data.username,code}; localStorage.setItem('chatCode',code); authModal.style.display='none';
 await loadUsers(); await loadMessages(); subscribeMessages(); subscribeTyping(); return true;
}
loginBtn.onclick=()=>{const code=codeInput.value.trim();if(!code)return alert('Enter your code'); loginWithCode(code);}
const savedCode=localStorage.getItem('chatCode');if(savedCode) loginWithCode(savedCode);

async function loadUsers(){
 if(!currentUser) return;
 const {data,error}=await client.from('chat_codes').select('username');
 if(error) return console.error(error);
 usersEl.innerHTML='';
 data.forEach(u=>{
  if(u.username===currentUser.username) return;
  const li=document.createElement('li');
  const nameDiv=document.createElement('div'); nameDiv.className='user-name';
  nameDiv.appendChild(createProfileCircle(u.username));
  const text=document.createElement('span'); text.textContent=u.username; nameDiv.appendChild(text);
  li.appendChild(nameDiv);
  const notif=document.createElement('span'); notif.className='user-notif';
  if(unreadCounts[u.username]) notif.textContent='‼️New Message‼️';
  li.appendChild(notif);
  li.onclick=()=>selectPrivateChat(u.username,li);
  if(privateChatUser===u.username) li.classList.add('active');
  usersEl.appendChild(li);
 });
 await loadGroups();
}

async function loadGroups(){
 const {data,error}=await client.from('groups').select('*');
 if(error) return console.error(error);
 data.forEach(g=>{
  const li=document.createElement('li');
  const nameDiv=document.createElement('div'); nameDiv.className='user-name';
  nameDiv.appendChild(createProfileCircle(g.name));
  const text=document.createElement('span'); text.textContent=g.name;
  nameDiv.appendChild(text);
  li.appendChild(nameDiv);
  const notif=document.createElement('span'); notif.className='user-notif';
  if(unreadCounts[g.id]) notif.textContent='‼️New Message‼️';
  li.appendChild(notif);
  li.onclick=()=>selectGroupChat(g,g.id,li);
  if(currentGroup && currentGroup.id===g.id) li.classList.add('active');
  usersEl.appendChild(li);
 });
}

function selectPrivateChat(username,liElement){
 privateChatUser=username; currentGroup=null; currentChatEl.textContent=username; returnGlobalBtn.style.display='inline-block';
 [...usersEl.children].forEach(li=>li.classList.remove('active')); if(liElement) liElement.classList.add('active');
 unreadCounts[username]=0; updateTitle(); loadMessages();
}
function selectGroupChat(group,id,liElement){
 currentGroup=group; privateChatUser=null; currentChatEl.textContent=group.name; returnGlobalBtn.style.display='inline-block';
 [...usersEl.children].forEach(li=>li.classList.remove('active')); if(liElement) liElement.classList.add('active');
 unreadCounts[id]=0; updateTitle(); loadMessages();
}
returnGlobalBtn.onclick=()=>{privateChatUser=null; currentGroup=null; currentChatEl.textContent='Global Chat'; returnGlobalBtn.style.display='none'; [...usersEl.children].forEach(li=>li.classList.remove('active')); loadMessages();}

sendBtn.onclick=sendMessage;
messageInput.addEventListener('keypress',(e)=>{if(e.key==='Enter') sendMessage();});
messageInput.addEventListener('input',async()=>{if(!currentUser)return; await client.from('typing_status').upsert({username:currentUser.username,typing:true,updated_at:new Date().toISOString()}); clearTimeout(typingTimeout); typingTimeout=setTimeout(async()=>{await client.from('typing_status').upsert({username:currentUser.username,typing:false,updated_at:new Date().toISOString()});},2000);});

async function sendMessage(){
 const msg=messageInput.value.trim(); if(!msg||!currentUser)return;
 if(privateChatUser){
   const data={sender:currentUser.username,receiver:privateChatUser,message:msg,created_at:new Date().toISOString()};
   appendMessage({username:currentUser.username,message:msg,created_at:data.created_at},'self');
   await client.from('private_messages').insert([data]);
 }else if(currentGroup){
   const data={group_id:currentGroup.id,sender:currentUser.username,message:msg,created_at:new Date().toISOString()};
   appendMessage({username:currentUser.username,message:msg,created_at:data.created_at},'self');
   await client.from('group_messages').insert([data]);
 }else{
   const data={username:currentUser.username,message:msg,created_at:new Date().toISOString()};
   appendMessage(data,'self');
   await client.from('global_messages').insert([data]);
 }
 messageInput.value='';
 await client.from('typing_status').upsert({username:currentUser.username,typing:false,updated_at:new Date().toISOString()});
}

async function loadMessages(){
 let data=[];
 if(privateChatUser){
   const res=await client.from('private_messages').select('*')
     .or(`sender.eq.${currentUser.username},receiver.eq.${currentUser.username}`)
     .or(`sender.eq.${privateChatUser},receiver.eq.${privateChatUser}`)
     .order('created_at',{ascending:true});
   data=res.data;
 }else if(currentGroup){
   const res=await client.from('group_messages').select('*').eq('group_id',currentGroup.id).order('created_at',{ascending:true});
   data=res.data;
 }else{
   const res=await client.from('global_messages').select('*').order('created_at',{ascending:true});
   data=res.data;
 }
 messagesEl.innerHTML='';
 data.forEach(m=>{const type=(m.username===currentUser.username || m.sender===currentUser.username)?'self':'other'; appendMessage({username:m.username||m.sender,message:m.message,created_at:m.created_at},type);});
}

function subscribeMessages(){
 if(window.messageChannel) window.messageChannel.unsubscribe();
 window.messageChannel=client.channel('public:global_messages')
   .on('postgres_changes',{event:'INSERT',schema:'public',table:'global_messages'},payload=>{const m=payload.new;if(!currentUser || m.username===currentUser.username)return; appendMessage(m,'other'); unreadCounts['global']=(unreadCounts['global']||0)+1; updateTitle();}).subscribe();

 if(window.privateChannel) window.privateChannel.unsubscribe();
 window.privateChannel=client.channel('public:private_messages')
   .on('postgres_changes',{event:'INSERT',schema:'public',table:'private_messages'},payload=>{
     const m=payload.new;if(!currentUser) return;
     if(m.sender!==currentUser.username && m.receiver!==currentUser.username){unreadCounts[m.sender]=(unreadCounts[m.sender]||0)+1; updateTitle();}
     if(privateChatUser && (m.sender===privateChatUser || m.receiver===privateChatUser)) appendMessage({username:m.sender,message:m.message,created_at:m.created_at},m.sender===currentUser.username?'self':'other');
   }).subscribe();

 if(window.groupChannel) window.groupChannel.unsubscribe();
 window.groupChannel=client.channel('public:group_messages')
   .on('postgres_changes',{event:'INSERT',schema:'public',table:'group_messages'},payload=>{
     const m=payload.new;if(!currentUser) return;
     if(currentGroup && currentGroup.id===m.group_id) appendMessage({username:m.sender,message:m.message,created_at:m.created_at},m.sender===currentUser.username?'self':'other');
     else { unreadCounts[m.group_id]=(unreadCounts[m.group_id]||0)+1; updateTitle(); }
   }).subscribe();
}

function subscribeTyping(){
 if(window.typingChannel) window.typingChannel.unsubscribe();
 window.typingChannel=client.channel('public:typing_status')
   .on('postgres_changes',{event:'*',schema:'public',table:'typing_status'},payload=>{
     const {username,typing}=payload.new; if(!currentUser || username===currentUser.username) return;
     if(typing) typingUsers.add(username); else typingUsers.delete(username); updateTypingIndicator();
   }).subscribe();
}

// ---------- GROUP CREATION ----------
groupButton.onclick=()=>{groupModal.style.display='flex'; searchUserInput.value=''; searchResults.innerHTML=''; selectedUsers=[];}
cancelGroup.onclick=()=>{groupModal.style.display='none'; selectedUsers=[]; groupNameInput.value='';};
let selectedUsers=[];
searchUserInput.addEventListener('input',async()=>{
 const val=searchUserInput.value.toLowerCase(); searchResults.innerHTML='';
 if(!val) return;
 const {data,error}=await client.from('chat_codes').select('username').ilike('username',`%${val}%`);
 if(error) return console.error(error);
 data.forEach(u=>{
  if(u.username===currentUser.username || selectedUsers.includes(u.username)) return;
  const div=document.createElement('div'); div.className='group-user';
  div.textContent=u.username;
  const btn=document.createElement('button'); btn.textContent='Add'; btn.onclick=()=>{selectedUsers.push(u.username); div.classList.add('group-selected'); btn.disabled=true;};
  div.appendChild(btn); searchResults.appendChild(div);
 });
});
createGroupSubmit.onclick=async()=>{
 if(!groupNameInput.value.trim() || selectedUsers.length===0) return alert('Enter name and add users');
 const {data,error}=await client.from('groups').insert([{name:groupNameInput.value.trim(),creator:currentUser.username}]).select().single();
 if(error) return console.error(error);
 const groupId=data.id;
 await client.from('group_members').insert(selectedUsers.map(u=>({group_id:groupId,username:u})));
 groupModal.style.display='none'; groupNameInput.value=''; selectedUsers=[]; await loadUsers();
};

setInterval(loadUsers,5000);
});
</script>
</body>
</html>
