<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BHC Chat with Groups</title>
<style>
body { margin:0; font-family:'Segoe UI',sans-serif; background:#0a0f1a; color:#fff; height:100vh; display:flex; flex-direction:column; }
header { background:#0f1524; padding:1rem; display:flex; justify-content:space-between; align-items:center; font-size:1.5rem; font-weight:bold; }
#currentChat { font-size:0.9rem; color:#7a7a7a; }
#returnGlobalBtn { display:none; background:#0b78e3; color:#fff; border:none; border-radius:5px; padding:0.3rem 0.6rem; cursor:pointer; }
#chatContainer { display:flex; flex:1; overflow:hidden; }
#userList, #groupList { width:220px; border-right:1px solid #1c2335; overflow-y:auto; padding:0.5rem; }
#userList h3, #groupList h3 { margin-top:0; margin-bottom:0.5rem; }
#userList ul, #groupList ul { list-style:none; padding:0; margin:0; }
#userList li, #groupList li { padding:0.5rem; cursor:pointer; border-radius:5px; display:flex; align-items:center; gap:0.5rem; }
#userList li:hover, #groupList li:hover { background:#1c2335; }
#userList li.active, #groupList li.active { background:#0b78e3; }
.chatMain { display:flex; flex-direction:column; flex:1; }
#typingIndicator { font-size:0.85rem; color:#7a7a7a; padding-left:1rem; margin-bottom:0.2rem; height:18px; }
#messages { flex:1; padding:1rem; overflow-y:auto; display:flex; flex-direction:column; gap:0.3rem; background:#101426; }
.message { padding:0.6rem 1rem; border-radius:15px; max-width:65%; word-break:break-word; display:flex; align-items:center; }
.message.self { background:#0b78e3; align-self:flex-end; color:#fff; flex-direction:row-reverse; }
.message.other { background:#1c2335; align-self:flex-start; color:#fff; }
.timestamp { font-size:0.65rem; color:#7a7a7a; margin-left:0.5rem; margin-right:0.5rem; }
#input { display:flex; padding:0.5rem; background:#141a2c; border-top:1px solid #1c2335; }
#input input { flex:1; padding:0.6rem 1rem; border-radius:20px 0 0 20px; border:none; background:#101426; color:#fff; }
#input button { padding:0.6rem 1.2rem; border:none; border-radius:0 20px 20px 0; background:#0b78e3; color:#fff; cursor:pointer; font-weight:bold; }
#authModal, #createGroupModal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); display:flex; align-items:center; justify-content:center; z-index:10; }
#authBox, #createGroupBox { background:#101426; padding:2rem; border-radius:15px; width:320px; display:flex; flex-direction:column; box-shadow:0 5px 20px rgba(0,0,0,0.5); }
#authBox input, #createGroupBox input { margin-bottom:1rem; padding:0.6rem; border-radius:8px; border:none; background:#141a2c; color:#fff; }
#authBox button, #createGroupBox button { padding:0.6rem; border:none; border-radius:8px; background:#0b78e3; color:#fff; font-weight:bold; cursor:pointer; }
.profile-circle { display:inline-flex; justify-content:center; align-items:center; width:30px; height:30px; border-radius:50%; color:#fff; font-weight:bold; font-size:0.8rem; flex-shrink:0; }
#createGroupBtn { width:100%; margin-bottom:0.5rem; background:#0b78e3; color:#fff; border:none; border-radius:5px; padding:0.4rem; cursor:pointer; }
</style>
</head>
<body>

<header>
  <span>BHC Chat</span>
  <span id="currentChat">Global Chat</span>
  <button id="returnGlobalBtn">Global Chat</button>
</header>

<div id="chatContainer">
  <div id="userList">
    <h3>Users</h3>
    <ul id="users"></ul>
  </div>
  <div id="groupList">
    <button id="createGroupBtn">+ Create Group</button>
    <h3>Groups</h3>
    <ul id="groups"></ul>
  </div>
  <div class="chatMain">
    <div id="typingIndicator"></div>
    <div id="messages"></div>
    <div id="input">
      <input type="text" id="messageInput" placeholder="Type your message...">
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<!-- Auth Modal -->
<div id="authModal">
  <div id="authBox">
    <h2>Enter Code</h2>
    <input type="text" id="codeInput" placeholder="Enter your code">
    <button id="loginBtn">Enter Chat</button>
  </div>
</div>

<!-- Create Group Modal -->
<div id="createGroupModal" style="display:none;">
  <div id="createGroupBox">
    <h2>Create Group</h2>
    <input type="text" id="groupNameInput" placeholder="Group Name">
    <input type="text" id="groupMembersInput" placeholder="Add members (comma-separated)">
    <button id="createGroupSubmit">Create Group</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const supabaseUrl = 'https://azpgwbxillscpwrraprl.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6cGd3YnhpbGxzY3B3cnJhcHJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg1MjQsImV4cCI6MjA3MjYzNDUyNH0.h7ZDxtH4pB3K5IzRB9goLJ1ldrY6EGf7CWT-ELGQ0i0';
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  let currentUser = null;
  let currentChatUser = null;
  let currentGroupId = null;

  const messagesEl = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const codeInput = document.getElementById('codeInput');
  const loginBtn = document.getElementById('loginBtn');
  const authModal = document.getElementById('authModal');
  const typingIndicator = document.getElementById('typingIndicator');
  const usersEl = document.getElementById('users');
  const groupsEl = document.getElementById('groups');
  const currentChatEl = document.getElementById('currentChat');
  const returnGlobalBtn = document.getElementById('returnGlobalBtn');
  const createGroupBtn = document.getElementById('createGroupBtn');
  const createGroupModal = document.getElementById('createGroupModal');
  const groupNameInput = document.getElementById('groupNameInput');
  const groupMembersInput = document.getElementById('groupMembersInput');
  const createGroupSubmit = document.getElementById('createGroupSubmit');

  let typingUsers = new Set();
  let typingTimeout;

  // Helpers
  function getInitials(name){ return name.split(' ').map(n=>n[0].toUpperCase()).join('').slice(0,2); }
  function stringToColor(str){ let hash=0; for(let i=0;i<str.length;i++){hash=str.charCodeAt(i)+((hash<<5)-hash);} return `hsl(${hash%360},70%,50%)`; }
  function createProfileCircle(username){ const span=document.createElement('span'); span.className='profile-circle'; span.style.background = stringToColor(username); span.textContent=getInitials(username); return span; }
  function appendMessage(message,type){ const div=document.createElement('div'); div.className='message '+type; div.appendChild(createProfileCircle(message.username)); const content=document.createElement('span'); content.innerHTML=`<strong>${message.username}</strong>: ${message.message} <span class="timestamp">${new Date(message.created_at).toLocaleTimeString()}</span>`; div.appendChild(content); messagesEl.appendChild(div); messagesEl.scrollTop = messagesEl.scrollHeight; }
  function updateTypingIndicator(){ if(typingUsers.size===0){ typingIndicator.textContent=''; return; } const names=Array.from(typingUsers); typingIndicator.textContent=names.length===1?`${names[0]} is typing...`:`${names.join(' and ')} are typing...`; }

  // Login
  async function loginWithCode(code){
    try{
      const { data, error } = await supabaseClient.from('chat_codes').select('username').eq('code', code).single();
      if(error||!data){ alert('Invalid code'); return false; }
      currentUser={username:data.username,code}; localStorage.setItem('chatCode',code); authModal.style.display='none';
      await loadUsers(); await loadGroups(); await loadMessages(); subscribeAll();
      return true;
    }catch(err){ alert('Login failed'); console.error(err); return false; }
  }
  loginBtn.onclick=()=>{ const code=codeInput.value.trim(); if(!code)return alert('Enter your code'); loginWithCode(code); };
  const savedCode=localStorage.getItem('chatCode'); if(savedCode) loginWithCode(savedCode);

  // Users
  async function loadUsers(){
    if(!currentUser) return;
    const { data, error } = await supabaseClient.from('chat_codes').select('username');
    if(error) return console.error(error);
    usersEl.innerHTML='';
    data.forEach(u=>{
      if(u.username===currentUser.username) return;
      const li=document.createElement('li');
      li.appendChild(createProfileCircle(u.username));
      const span=document.createElement('span'); span.textContent=u.username; li.appendChild(span);
      li.onclick=()=>{ selectPrivateChat(u.username, li); };
      if(currentChatUser===u.username) li.classList.add('active');
      usersEl.appendChild(li);
    });
  }

  function selectPrivateChat(username, li){
    currentChatUser=username; currentGroupId=null;
    currentChatEl.textContent=username; returnGlobalBtn.style.display='inline-block';
    [...usersEl.children].forEach(li=>li.classList.remove('active'));
    if(li) li.classList.add('active');
    loadMessages();
  }

  returnGlobalBtn.onclick=()=>{
    currentChatUser=null; currentGroupId=null;
    currentChatEl.textContent='Global Chat'; returnGlobalBtn.style.display='none';
    [...usersEl.children].forEach(li=>li.classList.remove('active'));
    [...groupsEl.children].forEach(li=>li.classList.remove('active'));
    loadMessages();
  };

  // Groups
  async function loadGroups(){
    if(!currentUser) return;
    const { data, error } = await supabaseClient.from('group_members').select('*, groups(name)').eq('username',currentUser.username);
    if(error) return console.error(error);
    groupsEl.innerHTML='';
    data.forEach(g=>{
      const li=document.createElement('li');
      li.appendChild(createProfileCircle(g.groups.name));
      const span=document.createElement('span'); span.textContent=g.groups.name; li.appendChild(span);
      li.onclick=()=>{ selectGroupChat(g.groups.id, g.groups.name, li); };
      if(currentGroupId===g.groups.id) li.classList.add('active');
      groupsEl.appendChild(li);
    });
  }

  function selectGroupChat(groupId, groupName, li){
    currentGroupId=groupId; currentChatUser=null;
    currentChatEl.textContent=groupName; returnGlobalBtn.style.display='inline-block';
    [...groupsEl.children].forEach(li=>li.classList.remove('active'));
    if(li) li.classList.add('active');
    loadMessages();
  }

  createGroupBtn.onclick=()=>{ createGroupModal.style.display='flex'; };
  createGroupSubmit.onclick=async()=>{
    const name=groupNameInput.value.trim();
    const members=groupMembersInput.value.split(',').map(s=>s.trim()).filter(Boolean);
    if(!name) return alert('Group name required');
    const { data, error } = await supabaseClient.from('groups').insert([{name, creator:currentUser.username}]).select().single();
    if(error) return console.error(error);
    const groupId=data.id;
    await supabaseClient.from('group_members').insert([...members.map(u=>({group_id:groupId, username:u})), {group_id:groupId, username:currentUser.username}]);
    createGroupModal.style.display='none'; groupNameInput.value=''; groupMembersInput.value='';
    loadGroups();
  };

  // Send Message
  async function sendMessage(){
    const msg=messageInput.value.trim(); if(!msg||!currentUser)return;
    if(currentGroupId){
      const data={group_id:currentGroupId, sender:currentUser.username, message:msg, created_at:new Date().toISOString()};
      appendMessage({username:currentUser.username,message:msg,created_at:data.created_at},'self');
      await supabaseClient.from('group_messages').insert([data]);
    } else if(currentChatUser){
      const privateData={sender:currentUser.username,receiver:currentChatUser,message:msg,created_at:new Date().toISOString()};
      appendMessage({username:currentUser.username,message:msg,created_at:privateData.created_at},'self');
      await supabaseClient.from('private_messages').insert([privateData]);
    } else {
      const globalData={username:currentUser.username,message:msg,created_at:new Date().toISOString()};
      appendMessage(globalData,'self');
      await supabaseClient.from('global_messages').insert([globalData]);
    }
    messageInput.value='';
    await supabaseClient.from('typing_status').upsert({username:currentUser.username,typing:false,updated_at:new Date().toISOString()});
  }
  sendBtn.onclick=sendMessage;
  messageInput.addEventListener('keypress',e=>{ if(e.key==='Enter') sendMessage(); });
  messageInput.addEventListener('input',async()=>{
    if(!currentUser) return;
    await supabaseClient.from('typing_status').upsert({username:currentUser.username,typing:true,updated_at:new Date().toISOString()});
    clearTimeout(typingTimeout);
    typingTimeout=setTimeout(async()=>{ await supabaseClient.from('typing_status').upsert({username:currentUser.username,typing:false,updated_at:new Date().toISOString()}); },2000);
  });

  // Load Messages
  async function loadMessages(){
    let data=[];
    if(currentGroupId){
      const res=await supabaseClient.from('group_messages').select('*').eq('group_id',currentGroupId).order('created_at',{ascending:true});
      data=res.data;
    } else if(currentChatUser){
      const res=await supabaseClient.from('private_messages').select('*')
        .or(`sender.eq.${currentUser.username},receiver.eq.${currentUser.username}`)
        .or(`sender.eq.${currentChatUser},receiver.eq.${currentChatUser}`)
        .order('created_at',{ascending:true});
      data=res.data;
    } else {
      const res=await supabaseClient.from('global_messages').select('*').order('created_at',{ascending:true});
      data=res.data;
    }
    messagesEl.innerHTML='';
    data.forEach(m=>{
      const type=(m.username===currentUser.username||m.sender===currentUser.username)?'self':'other';
      appendMessage({username:m.username||m.sender,message:m.message,created_at:m.created_at},type);
    });
  }

  // Subscribe all real-time
  function subscribeAll(){
    if(window.messageChannel) window.messageChannel.unsubscribe();
    window.messageChannel=supabaseClient.channel('public:global_messages')
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'global_messages'},payload=>{ const m=payload.new; if(!currentUser||m.username===currentUser.username) return; appendMessage(m,'other'); })
      .subscribe();

    if(window.privateChannel) window.privateChannel.unsubscribe();
    window.privateChannel=supabaseClient.channel('public:private_messages')
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'private_messages'},payload=>{ const m=payload.new; if(!currentUser||(m.sender!==currentUser.username&&m.receiver!==currentUser.username)) return; const type=m.sender===currentUser.username?'self':'other'; appendMessage({username:m.sender,message:m.message,created_at:m.created_at},type); })
      .subscribe();

    if(window.groupChannel) window.groupChannel.unsubscribe();
    window.groupChannel=supabaseClient.channel('public:group_messages')
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'group_messages'},payload=>{ const m=payload.new; if(!currentUser||![...m.group_id].includes(currentGroupId)) return; const type=m.sender===currentUser.username?'self':'other'; appendMessage({username:m.sender,message:m.message,created_at:m.created_at},type); })
      .subscribe();
  }

  setInterval(loadUsers,5000);
  setInterval(loadGroups,5000);
});
</script>
</body>
</html>
