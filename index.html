<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BHC Chat</title>
<style>
  /* ---------- Palette & base ---------- */
  :root{
    --bg: #0a0f1a;
    --panel: #0f1524;
    --card: #101426;
    --muted: #7a7a7a;
    --accent: #0b78e3;
    --accent-2: #0d8af3;
    --accent-glow: rgba(11,120,227,0.18);
    --danger: #ff4d4d;
    --surface: #121625;
    --radius: 10px;
    --txt: #e9eef8;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: "Segoe UI", Roboto, system-ui, -apple-system, "Helvetica Neue", Arial;
    background:var(--bg);
    color:var(--txt);
    display:flex;
    flex-direction:column;
    height:100vh;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* ---------- Header ---------- */
  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:18px 20px;
    background:linear-gradient(180deg,var(--panel), #0e1220);
    border-bottom:1px solid rgba(255,255,255,0.02);
    box-shadow:0 2px 12px rgba(0,0,0,0.35);
  }
  header strong{font-size:1.05rem;letter-spacing:0.4px}
  #currentChat{color:var(--muted); font-size:0.95rem}
  #returnGlobalBtn{
    display:none;
    background:linear-gradient(180deg,var(--accent),var(--accent-2));
    border:none;
    color:#fff;
    padding:6px 10px;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
    box-shadow:0 6px 18px rgba(11,120,227,0.12);
  }
  #returnGlobalBtn:hover{transform:translateY(-1px)}

  /* ---------- Layout ---------- */
  #chatContainer{display:flex;flex:1;overflow:hidden;min-height:0}
  aside#userList{
    width:260px;
    border-right:1px solid rgba(255,255,255,0.03);
    padding:12px;
    background:linear-gradient(180deg,transparent, rgba(255,255,255,0.01));
    overflow:auto;
  }
  /* userList scrollbar */
  aside#userList::-webkit-scrollbar{width:10px}
  aside#userList::-webkit-scrollbar-track{background:transparent}
  aside#userList::-webkit-scrollbar-thumb{background:#0e1730;border-radius:8px}

  #userList h3{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin:0 0 10px 0;
    font-weight:600;
    color:var(--txt);
  }

  .list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px}
  .list li{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    padding:10px;
    border-radius:10px;
    cursor:pointer;
    transition:background .12s, transform .06s;
    background:transparent;
  }
  .list li:hover{background:rgba(255,255,255,0.02); transform:translateY(-1px);}
  .list li.active{background:linear-gradient(90deg,var(--accent) 0%, rgba(11,120,227,0.15) 100%); box-shadow:0 6px 18px rgba(11,120,227,0.06)}

  .user-left{display:flex;align-items:center;gap:10px;min-width:0}
  .user-right{display:flex;align-items:center;gap:8px;flex-shrink:0}

  .profile-circle{
    width:40px;height:40px;border-radius:999px;display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:0.9rem;color:#fff;flex-shrink:0;
    box-shadow:0 4px 12px rgba(0,0,0,0.35);
  }

  .user-name{font-weight:600; font-size:0.95rem; color:var(--txt); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .user-sub{font-size:0.78rem;color:var(--muted)}

  .badge{
    background:var(--danger);
    color:#fff;
    padding:3px 8px;
    border-radius:999px;
    font-size:0.72rem;
    font-weight:700;
    box-shadow:0 6px 14px rgba(255,77,77,0.09);
  }

  /* ---------- Chat main ---------- */
  .chatMain{flex:1;display:flex;flex-direction:column;min-width:0}
  #typingIndicator{height:18px;padding:10px 16px;color:var(--muted);font-size:0.88rem}
  #messages{
    flex:1;
    padding:18px;
    overflow:auto;
    display:flex;
    flex-direction:column;
    gap:10px;
    background:linear-gradient(180deg,var(--card), #0b0f1b);
    min-height:0;
  }
  /* messages scrollbar */
  #messages::-webkit-scrollbar{width:10px}
  #messages::-webkit-scrollbar-track{background:transparent}
  #messages::-webkit-scrollbar-thumb{background:linear-gradient(180deg,var(--accent),var(--accent-2));border-radius:8px}

  .message{
    display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:12px;max-width:72%;word-break:break-word;
    box-shadow:0 6px 18px rgba(0,0,0,0.25)
  }
  .message.self{margin-left:auto;background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff;flex-direction:row-reverse}
  .message.other{margin-right:auto;background:rgba(255,255,255,0.02);color:var(--txt)}

  .timestamp{font-size:0.68rem;color:var(--muted);margin-left:6px;margin-right:6px}

  /* ---------- Input area ---------- */
  #input{display:flex;padding:14px;background:transparent;border-top:1px solid rgba(255,255,255,0.02)}
  .input-pill{
    display:flex;align-items:center;gap:8px;background:linear-gradient(180deg,#0b121f,#0b1020);padding:10px;border-radius:999px;flex:1;border:1px solid rgba(255,255,255,0.02);
    box-shadow:inset 0 1px 0 rgba(255,255,255,0.02);
  }
  .input-pill:focus-within{box-shadow:0 6px 30px var(--accent-glow);border-color:var(--accent);outline:0}
  #messageInput{
    flex:1;background:transparent;border:0;color:var(--txt);font-size:1rem;padding:8px 6px;outline:0;
  }
  #sendBtn{
    background:linear-gradient(90deg,var(--accent),var(--accent-2));border:none;color:#fff;padding:10px 14px;border-radius:999px;margin-left:12px;cursor:pointer;font-weight:700;
    box-shadow:0 10px 30px rgba(11,120,227,0.14);
  }
  #sendBtn:hover{transform:translateY(-2px);}

  /* ---------- Modals ---------- */
  .modal-backdrop{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(1,2,4,0.6);z-index:70;backdrop-filter:blur(4px)}
  .modal-card{background:linear-gradient(180deg,var(--panel), #0b0f1b);border-radius:12px;padding:18px;width:420px;box-shadow:0 16px 48px rgba(2,6,23,0.6)}
  .modal-card h2{margin:0 0 12px 0}
  .modal-input{width:100%;padding:10px 12px;border-radius:8px;background:#0b0f17;border:1px solid rgba(255,255,255,0.03);color:var(--txt);outline:0;margin-bottom:10px}
  .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
  .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
  .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--txt)}

  .selected-pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(11,120,227,0.12);font-weight:600;color:var(--txt);margin:4px}
  .group-user{display:flex;justify-content:space-between;align-items:center;padding:6px;border-radius:8px}

  /* small screens */
  @media (max-width:880px){
    aside#userList{width:200px}
    .profile-circle{width:34px;height:34px}
    .message{max-width:86%}
  }
</style>
</head>
<body>
<header>
  <strong>BHC Chat</strong>
  <div style="display:flex;align-items:center;gap:12px">
    <div id="currentChat">Global Chat</div>
    <button id="returnGlobalBtn">Global Chat</button>
  </div>
</header>

<div id="chatContainer">
  <aside id="userList">
    <h3>Users <button id="groupButton" class="btn ghost">+ Group</button></h3>
    <ul id="users" class="list" aria-live="polite"></ul>
  </aside>

  <main class="chatMain">
    <div id="typingIndicator" aria-hidden="true"></div>
    <div id="messages" role="log" aria-live="polite"></div>

    <div id="input">
      <div class="input-pill" role="search">
        <input id="messageInput" autocomplete="off" placeholder="Type your message..." />
      </div>
      <button id="sendBtn">Send</button>
    </div>
  </main>
</div>

<!-- auth modal -->
<div id="authModal" class="modal-backdrop">
  <div class="modal-card" id="authCard">
    <h2>Enter Code</h2>
    <input id="codeInput" class="modal-input" placeholder="Enter your code" />
    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button id="loginBtn" class="btn primary">Enter Chat</button>
    </div>
  </div>
</div>

<!-- group modal -->
<div id="groupModal" class="modal-backdrop" style="display:none">
  <div class="modal-card" id="groupCard">
    <button id="closeGroupModal" class="btn" style="position:absolute;right:14px;top:14px">✕</button>
    <h2>Create Group</h2>

    <input id="groupNameInput" class="modal-input" placeholder="Group name (required)" />
    <div id="selectedUsersWrap" style="min-height:34px;margin-bottom:8px"></div>

    <input id="searchUserInput" class="modal-input" placeholder="Search users to add" />
    <div id="searchResults" style="max-height:220px;overflow:auto;padding:6px;border-radius:8px;background:rgba(255,255,255,0.01)"></div>

    <div class="modal-actions">
      <button id="cancelGroupBtn" class="btn ghost">Cancel</button>
      <button id="createGroupSubmit" class="btn primary">Create Group</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/*
  Full chat client:
  - chat_codes login
  - realtime global/private/group messages
  - group creation (search, add/remove, creator auto-added)
  - unread counts (per-user and per-group) and title badge
  - typing status
  - pure CSS polished UI
*/

document.addEventListener('DOMContentLoaded', () => {
  const SUPABASE_URL = 'https://azpgwbxillscpwrraprl.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6cGd3YnhpbGxzY3B3cnJhcHJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg1MjQsImV4cCI6MjA3MjYzNDUyNH0.h7ZDxtH4pB3K5IzRB9goLJ1ldrY6EGf7CWT-ELGQ0i0'; // <-- PUT YOUR ANON KEY HERE
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // state
  let currentUser = null;        // { username }
  let privateChatUser = null;    // username string
  let currentGroup = null;       // { id, name, creator }
  let unreadCounts = {};         // key -> number (username or groupId or 'global')
  let selectedUsers = [];        // in group modal
  let typingSet = new Set();

  // ui refs
  const authModal = document.getElementById('authModal');
  const codeInput = document.getElementById('codeInput');
  const loginBtn = document.getElementById('loginBtn');

  const usersEl = document.getElementById('users');
  const messagesEl = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const currentChatEl = document.getElementById('currentChat');
  const returnGlobalBtn = document.getElementById('returnGlobalBtn');
  const typingIndicator = document.getElementById('typingIndicator');

  const groupButton = document.getElementById('groupButton');
  const groupModal = document.getElementById('groupModal');
  const closeGroupModal = document.getElementById('closeGroupModal');
  const groupNameInput = document.getElementById('groupNameInput');
  const searchUserInput = document.getElementById('searchUserInput');
  const searchResults = document.getElementById('searchResults');
  const selectedUsersWrap = document.getElementById('selectedUsersWrap');
  const createGroupSubmit = document.getElementById('createGroupSubmit');
  const cancelGroupBtn = document.getElementById('cancelGroupBtn');

  // helpers
  function initials(name){ return name.split(' ').map(s=>s[0]?.toUpperCase()||'').join('').slice(0,2); }
  function colorFor(name){ let h=0; for(let i=0;i<name.length;i++){h=name.charCodeAt(i)+((h<<5)-h);} return `hsl(${Math.abs(h)%360} 70% 50%)`; }
  function profileCircle(name){ const el=document.createElement('span'); el.className='profile-circle'; el.style.background=colorFor(name); el.textContent=initials(name); return el; }
  function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  function updateTitle(){
    const total = Object.values(unreadCounts).reduce((a,b)=>a+(b||0),0);
    document.title = total>0 ? `(${total}) BHC Chat` : 'BHC Chat';
  }

  function clearMessages(){ messagesEl.innerHTML = ''; messagesEl.scrollTop = 0; }

  function appendMessageObj({ who, text, at }, type){
    const item = document.createElement('div');
    item.className = 'message ' + (type === 'self' ? 'self' : 'other');
    item.appendChild(profileCircle(who));
    const span = document.createElement('span');
    span.innerHTML = `<strong>${escapeHtml(who)}</strong>: ${escapeHtml(text)} <span class="timestamp">${new Date(at).toLocaleTimeString()}</span>`;
    item.appendChild(span);
    messagesEl.appendChild(item);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  /* ---------- Login with chat_codes ---------- */
  async function loginWithCode(code){
    try{
      const { data, error } = await client.from('chat_codes').select('username').eq('code', code).single();
      if(error || !data) { alert('Invalid code'); return; }
      currentUser = { username: data.username };
      localStorage.setItem('chatCode', code);
      authModal.style.display = 'none';
      await loadUsersAndGroups();
      await loadMessages();
      subscribeAll();
      subscribeTyping();
    }catch(err){ console.error(err); alert('Login failed'); }
  }
  loginBtn.addEventListener('click', ()=>{ const c=codeInput.value.trim(); if(!c) return alert('Enter your code'); loginWithCode(c); });
  const saved = localStorage.getItem('chatCode');
  if(saved) loginWithCode(saved).catch(()=>{/*ignore*/});

  /* ---------- Users & groups list ---------- */
  async function loadUsersAndGroups(){
    if(!currentUser) return;
    // users
    const { data: users } = await client.from('chat_codes').select('username').order('username',{ascending:true});
    // groups where current user is a member (join)
    const { data: memberships } = await client
      .from('group_members')
      .select('group_id,groups(id,name,creator)')
      .eq('username', currentUser.username);

    usersEl.innerHTML = '';
    // users first
    (users || []).forEach(u=>{
      if(u.username === currentUser.username) return;
      const li = document.createElement('li');

      const left = document.createElement('div'); left.className='user-left';
      left.appendChild(profileCircle(u.username));
      const nameWrap = document.createElement('div'); nameWrap.style.minWidth='0';
      const name = document.createElement('div'); name.className='user-name'; name.textContent = u.username;
      nameWrap.appendChild(name);
      left.appendChild(nameWrap);

      const right = document.createElement('div'); right.className='user-right';
      const badge = document.createElement('div'); badge.className='badge'; badge.style.display = (unreadCounts[u.username] ? 'inline-flex' : 'none'); badge.textContent = unreadCounts[u.username] || '';
      right.appendChild(badge);

      // assemble
      const wrapper = document.createElement('div'); wrapper.style.display='flex'; wrapper.style.justifyContent='space-between'; wrapper.style.width='100%';
      wrapper.appendChild(left); wrapper.appendChild(right);
      li.appendChild(wrapper);

      li.onclick = ()=>selectPrivateChat(u.username, li);
      if(privateChatUser === u.username) li.classList.add('active');
      usersEl.appendChild(li);
    });

    // groups next (only those current user belongs to)
    (memberships || []).forEach(m=>{
      const g = m.groups;
      if(!g) return;
      const li = document.createElement('li');

      const left = document.createElement('div'); left.className='user-left';
      left.appendChild(profileCircle(g.name));
      const nameWrap = document.createElement('div'); nameWrap.style.minWidth='0';
      const name = document.createElement('div'); name.className='user-name'; name.textContent = g.name;
      const sub = document.createElement('div'); sub.className='user-sub'; sub.textContent = `Group • ${g.creator}`;
      nameWrap.appendChild(name); nameWrap.appendChild(sub);
      left.appendChild(nameWrap);

      const right = document.createElement('div'); right.className='user-right';
      const badge = document.createElement('div'); badge.className='badge'; badge.style.display = (unreadCounts[g.id] ? 'inline-flex' : 'none'); badge.textContent = unreadCounts[g.id] || '';
      right.appendChild(badge);

      const wrapper = document.createElement('div'); wrapper.style.display='flex'; wrapper.style.justifyContent='space-between'; wrapper.style.width='100%';
      wrapper.appendChild(left); wrapper.appendChild(right);
      li.appendChild(wrapper);

      li.onclick = ()=>selectGroupChat(g, li);
      if(currentGroup && currentGroup.id === g.id) li.classList.add('active');
      usersEl.appendChild(li);
    });

    updateTitle();
  }

  /* ---------- Select chat ---------- */
  async function selectPrivateChat(username, liElement){
    privateChatUser = username;
    currentGroup = null;
    currentChatEl.textContent = username;
    returnGlobalBtn.style.display = 'inline-block';
    [...usersEl.children].forEach(li=>li.classList.remove('active')); if(liElement) liElement.classList.add('active');
    unreadCounts[username] = 0; updateTitle();
    await loadMessages();
  }

  async function selectGroupChat(group, liElement){
    currentGroup = group;
    privateChatUser = null;
    currentChatEl.textContent = group.name;
    returnGlobalBtn.style.display = 'inline-block';
    [...usersEl.children].forEach(li=>li.classList.remove('active')); if(liElement) liElement.classList.add('active');
    unreadCounts[group.id] = 0; updateTitle();
    await loadMessages();
  }

  returnGlobalBtn.onclick = async () => {
    privateChatUser = null;
    currentGroup = null;
    currentChatEl.textContent = 'Global Chat';
    returnGlobalBtn.style.display = 'none';
    [...usersEl.children].forEach(li=>li.classList.remove('active'));
    await loadMessages();
  };

  /* ---------- Load messages (initial load) ---------- */
  async function loadMessages(){
    clearMessages();
    if(!currentUser) return;
    try{
      if(privateChatUser){
        const q = client.from('private_messages')
          .select('*')
          .or(`and(sender.eq.${currentUser.username},receiver.eq.${privateChatUser}),and(sender.eq.${privateChatUser},receiver.eq.${currentUser.username})`)
          .order('created_at',{ascending:true});
        const { data } = await q;
        (data||[]).forEach(m => appendMessageObj({ who: m.sender, text: m.message, at: m.created_at }, m.sender === currentUser.username ? 'self' : 'other'));
        return;
      }
      if(currentGroup){
        const { data } = await client.from('group_messages').select('*').eq('group_id', currentGroup.id).order('created_at',{ascending:true});
        (data||[]).forEach(m => appendMessageObj({ who: m.sender, text: m.message, at: m.created_at }, m.sender === currentUser.username ? 'self' : 'other'));
        return;
      }
      // global
      const { data } = await client.from('global_messages').select('*').order('created_at',{ascending:true});
      (data||[]).forEach(m => appendMessageObj({ who: m.username, text: m.message, at: m.created_at }, m.username === currentUser.username ? 'self' : 'other'));
    }catch(e){ console.error('loadMessages', e); }
  }

  /* ---------- Sending: insert only (NO local append) ---------- */
  sendBtn.onclick = sendMessage;
  messageInput.addEventListener('keypress', e => { if(e.key === 'Enter') sendMessage(); });

  async function sendMessage(){
    const text = messageInput.value.trim();
    if(!text || !currentUser) return;
    const now = new Date().toISOString();
    try{
      if(privateChatUser){
        await client.from('private_messages').insert([{ sender: currentUser.username, receiver: privateChatUser, message: text, created_at: now }]);
      } else if(currentGroup){
        await client.from('group_messages').insert([{ group_id: currentGroup.id, sender: currentUser.username, message: text, created_at: now }]);
      } else {
        await client.from('global_messages').insert([{ username: currentUser.username, message: text, created_at: now }]);
      }
    }catch(err){ console.error('send error', err); }
    messageInput.value = '';
    // update typing => false
    await client.from('typing_status').upsert({ username: currentUser.username, typing: false, updated_at: new Date().toISOString() });
  }

  /* ---------- Typing status ---------- */
  messageInput.addEventListener('input', async () => {
    if(!currentUser) return;
    await client.from('typing_status').upsert({ username: currentUser.username, typing: true, updated_at: new Date().toISOString() });
    clearTimeout(window._typingTO);
    window._typingTO = setTimeout(async () => {
      await client.from('typing_status').upsert({ username: currentUser.username, typing: false, updated_at: new Date().toISOString() });
    }, 1400);
  });

  /* ---------- Realtime subscriptions ---------- */
  function subscribeAll(){
    // global
    if(window._globalSub) window._globalSub.unsubscribe();
    window._globalSub = client.channel('public:global_messages')
      .on('postgres_changes', { event:'INSERT', schema:'public', table:'global_messages' }, payload => {
        const m = payload.new;
        if(!currentUser) return;
        if(!currentGroup && !privateChatUser){
          appendMessageObj({ who: m.username, text: m.message, at: m.created_at }, m.username === currentUser.username ? 'self' : 'other');
        } else {
          if(m.username !== currentUser.username){
            unreadCounts['global'] = (unreadCounts['global']||0) + 1;
            updateTitle();
            loadUsersAndGroups().catch(()=>{});
          }
        }
      }).subscribe();

    // private
    if(window._privateSub) window._privateSub.unsubscribe();
    window._privateSub = client.channel('public:private_messages')
      .on('postgres_changes', { event:'INSERT', schema:'public', table:'private_messages' }, payload => {
        const m = payload.new;
        if(!currentUser) return;
        // message relevant to me?
        if(m.receiver === currentUser.username || m.sender === currentUser.username){
          // if viewing that chat -> append
          if(privateChatUser && ((m.sender === privateChatUser && m.receiver === currentUser.username) || (m.sender === currentUser.username && m.receiver === privateChatUser))){
            appendMessageObj({ who: m.sender, text: m.message, at: m.created_at }, m.sender === currentUser.username ? 'self' : 'other');
          } else {
            // not viewing -> increment unread (only if I'm receiver)
            if(m.receiver === currentUser.username && m.sender !== currentUser.username){
              unreadCounts[m.sender] = (unreadCounts[m.sender] || 0) + 1;
              updateTitle();
              loadUsersAndGroups().catch(()=>{});
            }
          }
        }
      }).subscribe();

    // group
    if(window._groupSub) window._groupSub.unsubscribe();
    window._groupSub = client.channel('public:group_messages')
      .on('postgres_changes', { event:'INSERT', schema:'public', table:'group_messages' }, payload => {
        const m = payload.new;
        if(!currentUser) return;
        if(currentGroup && currentGroup.id === m.group_id){
          appendMessageObj({ who: m.sender, text: m.message, at: m.created_at }, m.sender === currentUser.username ? 'self' : 'other');
        } else {
          if(m.sender !== currentUser.username){
            unreadCounts[m.group_id] = (unreadCounts[m.group_id] || 0) + 1;
            updateTitle();
            loadUsersAndGroups().catch(()=>{});
          }
        }
      }).subscribe();
  }

  /* ---------- Typing subscription ---------- */
  function subscribeTyping(){
    if(window._typingSub) window._typingSub.unsubscribe();
    window._typingSub = client.channel('public:typing_status')
      .on('postgres_changes', { event:'*', schema:'public', table:'typing_status' }, payload => {
        if(!currentUser) return;
        const { username, typing } = payload.new;
        if(username === currentUser.username) return;
        if(typing) typingSet.add(username); else typingSet.delete(username);

        // show typing only if relevant
        if(privateChatUser && typingSet.has(privateChatUser)){
          typingIndicator.textContent = `${privateChatUser} is typing...`;
        } else if(currentGroup){
          // show generic if any group member (we don't fetch full member list here)
          const any = typingSet.size > 0;
          typingIndicator.textContent = any ? 'Someone is typing...' : '';
        } else {
          typingIndicator.textContent = '';
        }
      }).subscribe();
  }

  /* ---------- Group creation UI ---------- */
  groupButton.onclick = () => {
    if(!currentUser) return alert('Login first');
    selectedUsers = [];
    selectedUsersWrap.innerHTML = '';
    searchUserInput.value = '';
    searchResults.innerHTML = '';
    groupNameInput.value = '';
    groupModal.style.display = 'flex';
  };
  closeGroupModal.onclick = () => { groupModal.style.display = 'none'; };
  cancelGroupBtn.onclick = () => { groupModal.style.display = 'none'; };

  function renderSelectedPills(){
    selectedUsersWrap.innerHTML = '';
    selectedUsers.forEach(u => {
      const pill = document.createElement('div');
      pill.className = 'selected-pill';
      pill.textContent = u + ' ✖';
      pill.onclick = () => {
        selectedUsers = selectedUsers.filter(x => x !== u);
        renderSelectedPills();
        searchUsers(searchUserInput.value);
      };
      selectedUsersWrap.appendChild(pill);
    });
  }

  async function searchUsers(query){
    searchResults.innerHTML = '';
    const q = (query||'').trim();
    if(!q) return;
    const { data, error } = await client.from('chat_codes').select('username').ilike('username', `%${q}%`).limit(30);
    if(error) { console.error(error); return; }
    (data||[]).forEach(u => {
      if(u.username === currentUser.username) return;
      if(selectedUsers.includes(u.username)) return;
      const row = document.createElement('div'); row.className = 'group-user';
      const name = document.createElement('div'); name.textContent = u.username;
      const btn = document.createElement('button'); btn.className = 'btn primary'; btn.textContent = 'Add';
      btn.onclick = () => { selectedUsers.push(u.username); renderSelectedPills(); searchUsers(query); };
      row.appendChild(name); row.appendChild(btn);
      searchResults.appendChild(row);
    });
  }
  searchUserInput.addEventListener('input', e => searchUsers(e.target.value));

  createGroupSubmit.onclick = async () => {
    const name = groupNameInput.value.trim();
    if(!name) return alert('Enter a group name');
    if(selectedUsers.length === 0) return alert('Add at least one user');
    try{
      // create group
      const { data: group, error: gerr } = await client.from('groups').insert([{ name, creator: currentUser.username }]).select().single();
      if(gerr) throw gerr;
      const members = selectedUsers.map(u => ({ group_id: group.id, username: u }));
      members.push({ group_id: group.id, username: currentUser.username });
      const { error: merr } = await client.from('group_members').insert(members);
      if(merr) throw merr;
      groupModal.style.display = 'none';
      selectedUsers = [];
      await loadUsersAndGroups();
    }catch(err){ console.error('create group error', err); alert('Failed to create group'); }
  };

  // refresh user list occasionally to pick up new groups/members
  setInterval(()=>{ if(currentUser) loadUsersAndGroups(); }, 12000);

  // expose debug
  window._BHC = { client, loadUsersAndGroups, loadMessages, subscribeAll };

}); // end DOMContentLoaded
</script>
</body>
</html>

