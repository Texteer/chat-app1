<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Chat</title>
<style>
body { margin:0; font-family:'Segoe UI',sans-serif; background:#0a0f1a; color:#fff; display:flex; height:100vh; }
#sidebar { width:220px; background:#0c1521; padding:0.5rem; overflow-y:auto; border-right:1px solid #1c2335; }
.userItem { display:flex; align-items:center; gap:0.5rem; padding:0.5rem; cursor:pointer; border-radius:8px; transition:0.2s; }
.userItem:hover { background:#1c2335; }
.userItem.active { background:#0b78e3; }
.userItem .dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
#chatContainer { flex:1; display:flex; flex-direction:column; height:100vh; }
header { background:#0f1524; padding:1rem; text-align:center; font-size:1.5rem; font-weight:bold; }
#typingIndicator { font-size:0.85rem; color:#7a7a7a; padding-left:1rem; margin-bottom:0.2rem; height:18px; }
#messages { flex:1; padding:1rem; overflow-y:auto; display:flex; flex-direction:column; gap:0.3rem; }
.message { padding:0.6rem 1rem; border-radius:15px; max-width:65%; word-break:break-word; display:flex; align-items:center; }
.message.self { background:#0b78e3; align-self:flex-end; color:#fff; flex-direction:row-reverse; }
.message.other { background:#1c2335; align-self:flex-start; color:#fff; }
.timestamp { font-size:0.65rem; color:#7a7a7a; margin-left:0.5rem; margin-right:0.5rem; }
#input { display:flex; padding:0.5rem; background:#101426; border-top:1px solid #1c2335; }
#input input { flex:1; padding:0.6rem 1rem; border-radius:20px 0 0 20px; border:none; background:#141a2c; color:#fff; }
#input button { padding:0.6rem 1.2rem; border:none; border-radius:0 20px 20px 0; background:#0b78e3; color:#fff; cursor:pointer; font-weight:bold; }
#authModal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); display:flex; align-items:center; justify-content:center; z-index:10; }
#authBox { background:#101426; padding:2rem; border-radius:15px; width:320px; display:flex; flex-direction:column; box-shadow:0 5px 20px rgba(0,0,0,0.5); }
#authBox input { margin-bottom:1rem; padding:0.6rem; border-radius:8px; border:none; background:#141a2c; color:#fff; }
#authBox button { padding:0.6rem; border:none; border-radius:8px; background:#0b78e3; color:#fff; font-weight:bold; cursor:pointer; }
</style>
</head>
<body>

<div id="authModal">
  <div id="authBox">
    <h2>Enter Code</h2>
    <input type="text" id="codeInput" placeholder="Enter your code">
    <button id="loginBtn">Enter Chat</button>
  </div>
</div>

<div id="sidebar"></div>
<div id="chatContainer">
  <header>Global Chat</header>
  <div id="typingIndicator"></div>
  <div id="messages"></div>
  <div id="input">
    <input type="text" id="messageInput" placeholder="Type your message...">
    <button id="sendBtn">Send</button>
    <input type="file" id="fileInput" accept="image/*" style="display:none;">
    <button id="fileBtn">ðŸ“Ž</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const supabaseUrl = 'https://azpgwbxillscpwrraprl.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZob2t3b2F6dWhrd3JrcndlZGRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4ODk4NDUsImV4cCI6MjA3MjQ2NTg0NX0.oba9UV8YZ8wrB8Op2mAbRf2ns2-RGQRjY63wCLU5kKc';
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  let currentUser = null;
  let currentChat = { type:'global', target:null };
  const messagesEl = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const codeInput = document.getElementById('codeInput');
  const loginBtn = document.getElementById('loginBtn');
  const authModal = document.getElementById('authModal');
  const typingIndicator = document.getElementById('typingIndicator');
  const sidebar = document.getElementById('sidebar');

  let typingUsers = new Set();
  let typingTimeout;

  function getInitials(name){ return name.split(' ').map(n=>n[0].toUpperCase()).join('').slice(0,2); }
  function stringToColor(str){ let hash=0; for(let i=0;i<str.length;i++){ hash=str.charCodeAt(i)+((hash<<5)-hash);} return `hsl(${hash%360},70%,50%)`; }
  function createProfileCircle(username){ const span=document.createElement('span'); span.style.cssText=`display:inline-flex;justify-content:center;align-items:center;width:30px;height:30px;border-radius:50%;background:${stringToColor(username)};color:#fff;font-weight:bold;font-size:0.8rem;margin-right:0.5rem;`; span.textContent=getInitials(username); return span; }

  function appendMessage(message,type){
    const div=document.createElement('div'); div.className='message '+type; div.appendChild(createProfileCircle(message.username));
    const content=document.createElement('span'); content.innerHTML=`<strong>${message.username}</strong>: ${message.message} <span class="timestamp">${new Date(message.created_at).toLocaleTimeString()}</span>`; div.appendChild(content);
    messagesEl.appendChild(div); messagesEl.scrollTop=messagesEl.scrollHeight;
  }

  function updateTypingIndicator(){
    if(typingUsers.size===0){ typingIndicator.textContent=''; return;}
    const names = Array.from(typingUsers);
    typingIndicator.textContent = names.length===1 ? `${names[0]} is typing...` : `${names.join(' and ')} are typing...`;
  }

  async function loginWithCode(code){
    try{
      const { data,error } = await supabaseClient.from('chat_codes').select('username').eq('code',code).single();
      if(error || !data){ alert('Invalid code'); return false; }
      currentUser={username:data.username,code};
      localStorage.setItem('chatCode',code);
      authModal.style.display='none';
      await loadMessages();
      await loadUsers();
      subscribeMessages();
      subscribeTyping();
      subscribeUsers();
      return true;
    }catch(err){ console.error(err); alert('Login failed'); return false;}
  }

  loginBtn.onclick = () => { const code=codeInput.value.trim(); if(!code) return alert('Enter your code'); loginWithCode(code);}
  const savedCode = localStorage.getItem('chatCode'); if(savedCode) loginWithCode(savedCode);

  async function sendMessage(){
    const msg = messageInput.value.trim(); if(!msg||!currentUser) return;
    const newMessage = { username: currentUser.username, message: msg, created_at: new Date().toISOString() };
    appendMessage(newMessage,'self'); messageInput.value='';
    if(currentChat.type==='global'){
      await supabaseClient.from('global_messages').insert([newMessage]);
    } else {
      await supabaseClient.from('private_messages').insert([{sender:currentUser.username,receiver:currentChat.target,message:msg,created_at:new Date().toISOString()}]);
    }
    await supabaseClient.from('typing_status').upsert({ username:currentUser.username, typing:false, updated_at:new Date().toISOString() });
  }
  sendBtn.onclick=sendMessage;
  messageInput.addEventListener('keypress',e=>{if(e.key==='Enter') sendMessage();});
  messageInput.addEventListener('input', async ()=>{
    if(!currentUser) return;
    await supabaseClient.from('typing_status').upsert({ username:currentUser.username, typing:true, updated_at:new Date().toISOString() });
    clearTimeout(typingTimeout); typingTimeout=setTimeout(async()=>{await supabaseClient.from('typing_status').upsert({username:currentUser.username,typing:false,updated_at:new Date().toISOString()});},2000);
  });

  async function loadMessages(){
    messagesEl.innerHTML='';
    if(currentChat.type==='global'){
      const { data,error } = await supabaseClient.from('global_messages').select('*').order('created_at',{ascending:true});
      if(error) return console.error(error);
      data.forEach(m=>appendMessage(m,m.username===currentUser.username?'self':'other'));
    } else {
      const { data,error } = await supabaseClient.from('private_messages').select('*').or(`and(sender.eq.${currentUser.username},receiver.eq.${currentChat.target}),and(sender.eq.${currentChat.target},receiver.eq.${currentUser.username})`).order('created_at',{ascending:true});
      if(error) return console.error(error);
      data.forEach(m=>appendMessage(m,m.sender===currentUser.username?'self':'other'));
    }
  }

  function subscribeMessages(){
    if(window.messageChannel) window.messageChannel.unsubscribe();
    window.messageChannel = supabaseClient.channel('messages').on('postgres_changes',{event:'INSERT',schema:'public',table:'global_messages'},payload=>{const m=payload.new;if(!currentUser||m.username===currentUser.username) return;if(currentChat.type==='global') appendMessage(m,'other');}).subscribe();
    window.privateChannel = supabaseClient.channel('private_messages').on('postgres_changes',{event:'INSERT',schema:'public',table:'private_messages'},payload=>{const m=payload.new;if(currentChat.type==='private'&&(m.sender===currentChat.target||m.receiver===currentChat.target)){appendMessage(m,m.sender===currentUser.username?'self':'other');}}).subscribe();
  }

  function subscribeTyping(){
    if(window.typingChannel) window.typingChannel.unsubscribe();
    window.typingChannel = supabaseClient.channel('typing_status').on('postgres_changes',{event:'*',schema:'public',table:'typing_status'},payload=>{
      const { username, typing } = payload.new;
      if(!currentUser||username===currentUser.username) return;
      if(typing) typingUsers.add(username); else typingUsers.delete(username); updateTypingIndicator();
    }).subscribe();
  }

  async function loadUsers(){
    const { data,error } = await supabaseClient.from('users').select('*');
    if(error) return console.error(error);
    sidebar.innerHTML='';
    const globalItem=document.createElement('div'); globalItem.className='userItem global'; globalItem.textContent='Global Chat';
    globalItem.onclick=()=>{currentChat={type:'global',target:null}; document.querySelector('#chatContainer header').textContent='Global Chat'; loadMessages();};
    sidebar.appendChild(globalItem);
    data.forEach(u=>{
      const item=document.createElement('div'); item.className='userItem';
      const circle=document.createElement('span'); circle.className='dot'; circle.style.background=u.online?'#0f0':'#555';
      item.appendChild(circle);
      const name=document.createElement('span'); name.textContent=u.username; item.appendChild(name);
      item.onclick=()=>{if(currentChat.type==='private'&&currentChat.target===u.username){currentChat={type:'global',target:null}; document.querySelector('#chatContainer header').textContent='Global Chat';}else{currentChat={type:'private',target:u.username}; document.querySelector('#chatContainer header').textContent='DM: '+u.username;} loadMessages();};
      sidebar.appendChild(item);
    });
  }

  function subscribeUsers(){
    setInterval(async()=>{
      if(!currentUser) return;
      await supabaseClient.from('users').upsert({username:currentUser.username,online:true,last_seen:new Date().toISOString()},{onConflict:'username'});
    },5000);
  }
});
</script>
</body>
</html>
