<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BHC Chat â€” Fixed Groups</title>
<style>
:root{--bg:#0a0f1a;--panel:#101426;--muted:#7a7a7a;--accent:#0b78e3;--card:#1c2335}
body{margin:0;font-family:Segoe UI,system-ui,-apple-system,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:#fff;height:100vh;display:flex;flex-direction:column}
header{background:#0f1524;padding:1rem;display:flex;align-items:center;justify-content:space-between}
#currentChat{font-size:0.95rem;color:var(--muted)}
#returnGlobalBtn{display:none;background:var(--accent);border:none;color:#fff;border-radius:6px;padding:6px 10px;cursor:pointer}
#chatContainer{display:flex;flex:1;overflow:hidden}
#userList{width:240px;border-right:1px solid #1c2335;overflow:auto;padding:0.5rem}
#userList h3{display:flex;align-items:center;justify-content:space-between;margin:0 0 8px 0}
#openGroupModalBtn{background:var(--accent);border:none;color:#fff;border-radius:6px;padding:6px 8px;cursor:pointer;font-size:0.85rem}
ul.list{list-style:none;padding:0;margin:0}
ul.list li{display:flex;align-items:center;gap:8px;padding:8px;border-radius:6px;cursor:pointer}
ul.list li:hover{background:var(--card)}
ul.list li.active{background:var(--accent)}
.profile-circle{display:inline-flex;align-items:center;justify-content:center;width:34px;height:34px;border-radius:999px;font-weight:700;font-size:0.85rem;color:#fff;flex-shrink:0}
.chatMain{flex:1;display:flex;flex-direction:column}
#typingIndicator{height:18px;padding:8px 12px;color:var(--muted);font-size:0.85rem}
#messages{flex:1;padding:14px;overflow:auto;display:flex;flex-direction:column;gap:8px;background:var(--panel)}
.message{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:12px;max-width:70%;word-break:break-word}
.message.self{margin-left:auto;background:var(--accent);flex-direction:row-reverse}
.message.other{margin-right:auto;background:var(--card)}
.timestamp{font-size:0.65rem;color:var(--muted);margin-left:6px;margin-right:6px}
#input{display:flex;padding:10px;background:#141a2c;border-top:1px solid #1c2335}
#messageInput{flex:1;padding:10px;border-radius:20px 0 0 20px;border:none;background:#101426;color:#fff}
#sendBtn{padding:10px 14px;border:none;border-radius:0 20px 20px 0;background:var(--accent);color:#fff;cursor:pointer;font-weight:600}
/* modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:50}
.modal{background:var(--panel);padding:18px;border-radius:12px;width:420px;max-height:80vh;overflow:auto;position:relative}
.closeModal{position:absolute;right:12px;top:12px;background:var(--accent);border:none;color:#fff;width:28px;height:28px;border-radius:50%;cursor:pointer}
.user-search-result{display:flex;justify-content:space-between;align-items:center;padding:6px;border-radius:6px}
.user-search-result:hover{background:var(--card)}
#selectedMembers{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0}
.member-tag{background:var(--accent);padding:4px 8px;border-radius:999px;display:flex;align-items:center;gap:6px}
.member-tag button{background:transparent;border:none;color:#fff;cursor:pointer}
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:12px"><strong>BHC Chat</strong></div>
  <div style="display:flex;align-items:center;gap:12px">
    <span id="currentChat">Global Chat</span>
    <button id="returnGlobalBtn">Global Chat</button>
  </div>
</header>

<div id="chatContainer">
  <aside id="userList">
    <h3>
      Users
      <button id="openGroupModalBtn">+ Group</button>
    </h3>
    <ul id="users" class="list"></ul>
  </aside>

  <main class="chatMain">
    <div id="typingIndicator"></div>
    <div id="messages"></div>
    <div id="input">
      <input id="messageInput" placeholder="Type your message..." autocomplete="off" />
      <button id="sendBtn">Send</button>
    </div>
  </main>
</div>

<!-- auth modal -->
<div id="authModal" class="modal-backdrop">
  <div class="modal" id="authBox">
    <h2>Enter Code</h2>
    <input id="codeInput" placeholder="Enter your code" />
    <button id="loginBtn">Enter Chat</button>
  </div>
</div>

<!-- create group modal -->
<div id="createGroupModal" class="modal-backdrop" style="display:none">
  <div class="modal" id="createGroupBox">
    <button class="closeModal">&times;</button>
    <h2>Create Group</h2>
    <input id="groupNameInput" placeholder="Group name" />
    <input id="searchUserInput" placeholder="Search users to add" />
    <div id="searchResults"></div>
    <div id="selectedMembers"></div>
    <button id="createGroupSubmit">Create Group</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const supabaseUrl = 'https://azpgwbxillscpwrraprl.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6cGd3YnhpbGxzY3B3cnJhcHJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg1MjQsImV4cCI6MjA3MjYzNDUyNH0.h7ZDxtH4pB3K5IzRB9goLJ1ldrY6EGf7CWT-ELGQ0i0';
  const supabase = window.supabase;
  const client = supabase.createClient(supabaseUrl, supabaseKey);

  let currentUser = null, currentChatUser = null, currentGroupId = null;
  let availableUsers = [], selectedMembers = [], typingUsers = new Set();

  const authModal = document.getElementById('authModal'), codeInput = document.getElementById('codeInput'), loginBtn = document.getElementById('loginBtn');
  const usersEl = document.getElementById('users'), messagesEl = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput'), sendBtn = document.getElementById('sendBtn');
  const currentChatEl = document.getElementById('currentChat'), returnGlobalBtn = document.getElementById('returnGlobalBtn');

  const openGroupModalBtn = document.getElementById('openGroupModalBtn');
  const createGroupModal = document.getElementById('createGroupModal');
  const closeModalBtn = createGroupModal.querySelector('.closeModal');
  const groupNameInput = document.getElementById('groupNameInput');
  const searchUserInput = document.getElementById('searchUserInput');
  const searchResults = document.getElementById('searchResults');
  const selectedMembersDiv = document.getElementById('selectedMembers');
  const createGroupSubmit = document.getElementById('createGroupSubmit');

  function initials(name){ return name.split(' ').map(n=>n[0]?.toUpperCase()||'').join('').slice(0,2); }
  function colorFor(name){ let h=0; for(let i=0;i<name.length;i++) h = name.charCodeAt(i) + ((h<<5)-h); return `hsl(${Math.abs(h)%360} 70% 50%)`; }
  function profileCircle(name){ const s=document.createElement('span'); s.className='profile-circle'; s.style.background=colorFor(name); s.textContent=initials(name); return s; }
  function clearMessages(){ messagesEl.innerHTML=''; messagesEl.scrollTop=0; }
  function appendMessageObj({who,text,at}, type){ const div=document.createElement('div'); div.className='message '+(type==='self'?'self':'other'); div.appendChild(profileCircle(who)); const span=document.createElement('span'); span.innerHTML=`<strong>${who}</strong>: ${text} <span class="timestamp">${new Date(at).toLocaleTimeString()}</span>`; div.appendChild(span); messagesEl.appendChild(div); messagesEl.scrollTop=messagesEl.scrollHeight; }

  async function loadUsersAndGroups(){
    if(!currentUser) return;
    const { data: usersData } = await client.from('chat_codes').select('username').order('username',{ascending:true});
    availableUsers = usersData.filter(u => u.username!==currentUser.username);

    const { data: membership } = await client.from('group_members').select('group_id,groups(id,name)').eq('username', currentUser.username);

    usersEl.innerHTML='';
    availableUsers.forEach(u=>{
      const li=document.createElement('li'); li.appendChild(profileCircle(u.username));
      const span=document.createElement('span'); span.textContent=u.username; li.appendChild(span);
      li.onclick=()=>{ currentChatUser=u.username; currentGroupId=null; currentChatEl.textContent=u.username; loadPrivateChat(); highlightActive(li); returnGlobalBtn.style.display='inline'; };
      usersEl.appendChild(li);
    });

    membership?.forEach(m=>{
      const li=document.createElement('li'); li.appendChild(profileCircle(m.groups.name));
      const span=document.createElement('span'); span.textContent=m.groups.name; li.appendChild(span);
      li.onclick=()=>{ currentGroupId=m.groups.id; currentChatUser=null; currentChatEl.textContent=m.groups.name; loadGroupChat(); highlightActive(li); returnGlobalBtn.style.display='inline'; };
      usersEl.appendChild(li);
    });
  }

  function highlightActive(activeLi){
    [...usersEl.querySelectorAll('li')].forEach(li=>li.classList.remove('active'));
    if(activeLi) activeLi.classList.add('active');
  }

  async function loginWithCode(code){
    const { data, error } = await client.from('chat_codes').select('username').eq('code', code).single();
    if(error || !data){ alert('Invalid code'); return; }
    currentUser={username:data.username,code}; localStorage.setItem('chatCode', code); authModal.style.display='none';
    await loadUsersAndGroups();
    subscribeTyping();
  }

  loginBtn.onclick = ()=>{ const c=codeInput.value.trim(); if(!c) return alert('Enter your code'); loginWithCode(c); };
  const savedCode = localStorage.getItem('chatCode'); if(savedCode) loginWithCode(savedCode);

  // ------------------- Messaging -------------------
  async function sendMessage(){
    const msg = messageInput.value.trim(); if(!msg) return;
    const payload = {username: currentUser.username, message: msg, created_at:new Date().toISOString()};
    if(currentGroupId){
      await client.from('group_messages').insert({...payload, group_id:currentGroupId});
    } else if(currentChatUser){
      await client.from('private_messages').insert({...payload, to_username:currentChatUser});
    } else {
      await client.from('global_messages').insert(payload);
    }
    messageInput.value=''; 
  }

  sendBtn.onclick=sendMessage;
  messageInput.addEventListener('keypress', e=>{ if(e.key==='Enter') sendMessage(); });

  // ------------------- Load chats -------------------
  async function loadPrivateChat(){
    if(!currentChatUser) return; clearMessages();
    const { data } = await client.from('private_messages').select('*').or(`and(username.eq.${currentUser.username},to_username.eq.${currentChatUser}),and(username.eq.${currentChatUser},to_username.eq.${currentUser.username})`).order('created_at',{ascending:true});
    data.forEach(m=>appendMessageObj({who:m.username,text:m.message,at:m.created_at}, m.username===currentUser.username?'self':'other'));
  }

  async function loadGroupChat(){
    if(!currentGroupId) return; clearMessages();
    const { data } = await client.from('group_messages').select('*').eq('group_id', currentGroupId).order('created_at',{ascending:true});
    data.forEach(m=>appendMessageObj({who:m.username,text:m.message,at:m.created_at}, m.username===currentUser.username?'self':'other'));
  }

  // ------------------- Realtime -------------------
  function subscribeTyping(){
    client.channel('public:typing_status').on('postgres_changes',{event:'*',schema:'public',table:'typing_status'},payload=>{
      const {username,typing}=payload.new;
      if(!currentUser || username===currentUser.username) return;
      if(typing) typingUsers.add(username); else typingUsers.delete(username);
      document.getElementById('typingIndicator').textContent=typingUsers.size?Array.from(typingUsers).join(' and ')+' is typing...':'';
    }).subscribe();
  }

  function subscribeMessages(){
    // global
    client.channel('public:global_messages').on('postgres_changes',{event:'INSERT',schema:'public',table:'global_messages'},payload=>{
      if(!currentGroupId && !currentChatUser && payload.new.username!==currentUser.username)
        appendMessageObj({who:payload.new.username,text:payload.new.message,at:payload.new.created_at},'other');
    }).subscribe();
    // private
    client.channel('public:private_messages').on('postgres_changes',{event:'INSERT',schema:'public',table:'private_messages'},payload=>{
      const m=payload.new;
      if((currentChatUser && ((m.username===currentChatUser && m.to_username===currentUser.username)||(m.username===currentUser.username && m.to_username===currentChatUser))) )
        appendMessageObj({who:m.username,text:m.message,at:m.created_at}, m.username===currentUser.username?'self':'other');
    }).subscribe();
    // group
    client.channel('public:group_messages').on('postgres_changes',{event:'INSERT',schema:'public',table:'group_messages'},payload=>{
      const m=payload.new;
      if(currentGroupId && m.group_id===currentGroupId)
        appendMessageObj({who:m.username,text:m.message,at:m.created_at}, m.username===currentUser.username?'self':'other');
    }).subscribe();
  }
  subscribeMessages();

  // ------------------- Global chat return -------------------
  returnGlobalBtn.onclick = ()=>{ currentChatUser=null; currentGroupId=null; currentChatEl.textContent='Global Chat'; highlightActive(); clearMessages(); subscribeMessages(); returnGlobalBtn.style.display='none'; };

  // ------------------- Group Modal -------------------
  openGroupModalBtn.onclick = ()=>createGroupModal.style.display='flex';
  closeModalBtn.onclick = ()=>createGroupModal.style.display='none';
  createGroupModal.onclick = e=>{ if(e.target===createGroupModal) createGroupModal.style.display='none'; };

  searchUserInput.addEventListener('input', async ()=>{
    const q = searchUserInput.value.trim().toLowerCase();
    if(!q){ searchResults.innerHTML=''; return; }
    const results = availableUsers.filter(u=>u.username.toLowerCase().includes(q) && !selectedMembers.includes(u.username));
    searchResults.innerHTML='';
    results.forEach(u=>{
      const div=document.createElement('div'); div.className='user-search-result';
      div.innerHTML=`<span>${u.username}</span>`;
      const btn=document.createElement('button'); btn.textContent='Add'; btn.onclick=()=>{ selectedMembers.push(u.username); updateSelectedMembers(); searchUserInput.value=''; searchResults.innerHTML=''; };
      div.appendChild(btn); searchResults.appendChild(div);
    });
  });

  function updateSelectedMembers(){
    selectedMembersDiv.innerHTML='';
    selectedMembers.forEach(u=>{
      const span=document.createElement('div'); span.className='member-tag';
      span.textContent=u; const btn=document.createElement('button'); btn.textContent='x'; btn.onclick=()=>{ selectedMembers=selectedMembers.filter(x=>x!==u); updateSelectedMembers(); };
      span.appendChild(btn); selectedMembersDiv.appendChild(span);
    });
  }

  createGroupSubmit.onclick = async ()=>{
    const name = groupNameInput.value.trim();
    if(!name) return alert('Enter a group name');
    if(selectedMembers.length===0) return alert('Add at least one member');
    try{
      const { data: group, error: gerr } = await client.from('groups').insert({name, creator: currentUser.username}).select().single();
      if(gerr) throw gerr;
      const members = [...selectedMembers,currentUser.username].map(u=>({group_id:group.id,username:u}));
      const { error: merr } = await client.from('group_members').insert(members);
      if(merr) throw merr;
      createGroupModal.style.display='none'; selectedMembers=[]; updateSelectedMembers(); await loadUsersAndGroups();
    }catch(e){ console.error(e); alert('Failed to create group'); }
  };
});
</script>
</body>
</html>
